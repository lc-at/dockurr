#!/usr/bin/bash

# This script will run all services/workers for dockurr
# FOR TESTING/DEVELOPMENT ONLY

# shellcheck disable=SC2064

int_count=0
handle_trap() {
        echo "Caught SIGINT, killing all processes... press ^C again to force kill"
        int_count=$((int_count + 1))
        if [ "$int_count" -gt 1 ]; then
                echo "Caught SIGINT twice, sending SIGKILL to all childs..."
                kill -KILL -- $$
        fi

        for job in $(jobs -p); do
                kill "$job" 2>/dev/null &
        done
        wait
}

trap handle_trap SIGINT SIGTERM

_tput() {
        if command -v tput > /dev/null; then
                tput "$@"
        fi
}

add_prefix() {  # usage: add_prefix name color
        prefix="$(_tput sgr0)"
        prefix="$prefix$(_tput setab "$2")"
        prefix="$prefix$(_tput bold)"
        suffix="$(_tput sgr0)"
        sed "s/^/$prefix$1$suffix: /"
}

print_banner() {
        # credits to this guy: https://gist.github.com/dhrp/5733652
        tput setaf green
        tput bold
        cat <<EOF
  _______
< dockurr >
  -------
      \           ##        .           
       \      ## ## ##       ==           
        \  ## ## ## ##      ===          
       /""""""""""""""""\___/ ===       
  ~~~ {~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~ 
       \______ o          __/            
         \    \        __/             
          \____\______/                

EOF
        tput sgr0
}

print_banner

flask createdb

LEVEL=DEBUG
if [ -z "$DEBUG" ]; then
        LEVEL=INFO
fi

flask run --debug 2>&1 | add_prefix flask 125 &
celery \
        -A dockurr.make_celery worker \
        -l $LEVEL 2>&1 | add_prefix celery-worker 130 &
celery \
        -A dockurr.make_celery beat \
        -S redbeat.RedBeatScheduler \
        -l $LEVEL 2>&1 | add_prefix celery-beat 131 &

wait
